name: YouTube Background Jobs

on:
  schedule:
    # Snapshot collection: Every 6 hours
    - cron: '0 */6 * * *'
    # Trend calculation: Daily at 1 AM UTC
    - cron: '0 1 * * *'

  workflow_dispatch:
    inputs:
      job_type:
        description: 'Which job to run'
        required: false
        default: both
        type: choice
        options:
          - snapshots
          - trends
          - both

# Permissions needed for the workflow to run
permissions:
  contents: read
  actions: read

jobs:
  snapshots:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 */6 * * *') ||
      (github.event_name == 'workflow_dispatch' &&
        contains(fromJSON('["snapshots","both"]'), github.event.inputs.job_type))
    steps:
      - name: Debug context
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Schedule: ${{ github.event.schedule }}"
          echo "Job type: ${{ github.event.inputs.job_type }}"

      - name: Collect Video Snapshots
        env:
          APP_URL: ${{ secrets.APP_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          set -euo pipefail

          echo "▶ Starting snapshot collection..."

          if [ -z "${APP_URL:-}" ]; then
            echo "❌ APP_URL secret is missing"
            exit 1
          fi

          if [ -z "${CRON_SECRET:-}" ]; then
            echo "❌ CRON_SECRET secret is missing"
            exit 1
          fi

          response=$(curl -s -w "\n%{http_code}" \
            -X POST "${APP_URL}/api/youtube/snapshots/collect" \
            -H "Authorization: Bearer ${CRON_SECRET}" \
            -H "Content-Type: application/json" \
            --max-time 300)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Status: $http_code"
          echo "Response: $body"

          if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
            echo "❌ Snapshot job failed"
            exit 1
          fi

          echo "✅ Snapshot job completed successfully"

  trends:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 1 * * *') ||
      (github.event_name == 'workflow_dispatch' &&
        contains(fromJSON('["trends","both"]'), github.event.inputs.job_type))
    steps:
      - name: Debug context
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Schedule: ${{ github.event.schedule }}"
          echo "Job type: ${{ github.event.inputs.job_type }}"

      - name: Calculate Trends
        env:
          APP_URL: ${{ secrets.APP_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          set -euo pipefail

          echo "▶ Starting trend calculation..."

          if [ -z "${APP_URL:-}" ]; then
            echo "❌ APP_URL secret is missing"
            exit 1
          fi

          if [ -z "${CRON_SECRET:-}" ]; then
            echo "❌ CRON_SECRET secret is missing"
            exit 1
          fi

          response=$(curl -s -w "\n%{http_code}" \
            -X POST "${APP_URL}/api/youtube/trends/calculate" \
            -H "Authorization: Bearer ${CRON_SECRET}" \
            -H "Content-Type: application/json" \
            --max-time 300)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "HTTP Status: $http_code"
          echo "Response: $body"

          if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
            echo "❌ Trend calculation failed"
            exit 1
          fi

          echo "✅ Trend calculation completed successfully"
