// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// User model - synced with Clerk
model User {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  clerkId       String   @unique
  email         String
  username      String?  @unique
  displayName   String?
  avatarUrl     String?
  bio           String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  preferences   UserPreferences?
  favorites     Favorite[]
  playlists     Playlist[]
  reviews       Review[]
  forumPosts    ForumPost[]
  forumReplies  ForumReply[]
  sharedPlaylists SharedPlaylist[]
  recentlyViewed RecentlyViewed[]
  viewingLogs   ViewingLog[]
  playlistEngagements PlaylistEngagementEvent[] @relation("UserPlaylistEngagementOwnership")
  playlistEngagementActions PlaylistEngagementEvent[] @relation("UserPlaylistEngagementActor")
  aiChatEvents AiChatEvent[]
  aiChatSessions AiChatSession[]
  
  // Social features
  followers     Follow[] @relation("UserFollowers")
  following     Follow[] @relation("UserFollowing")
  likedPlaylists LikedPlaylist[]
  viewingLogComments ViewingLogComment[]
  commentReactions CommentReaction[]
  watchlistItems WatchlistItem[]

  @@map("users")
}

// User preferences from onboarding
model UserPreferences {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  userId            String   @unique @db.ObjectId
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Genre preferences (stored as array of genre IDs from TMDB)
  favoriteGenres    Int[]    @default([])
  dislikedGenres    Int[]    @default([])
  
  // Content preferences
  preferredTypes    String[] @default([]) // ["movie", "tv"]
  minRating         Float?    // Minimum rating user wants to see
  preferredLanguages String[] @default([]) // ISO 639-1 codes
  
  // Release year preferences
  minYear           Int?
  maxYear           Int?
  
  // Onboarding completed flag
  onboardingCompleted Boolean @default(false)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("user_preferences")
}

// Favorites - movies and TV shows user likes
model Favorite {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // TMDB data
  tmdbId        Int      // Movie or TV show ID from TMDB
  mediaType     String   // "movie" or "tv"
  title         String
  posterPath    String?
  backdropPath String?
  releaseDate   String?  // For movies
  firstAirDate  String?  // For TV shows
  
  createdAt     DateTime @default(now())

  @@unique([userId, tmdbId, mediaType])
  @@map("favorites")
  @@index([userId])
}

// Watchlist - movies and TV shows user wants to watch
model WatchlistItem {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // TMDB data
  tmdbId        Int      // Movie or TV show ID from TMDB
  mediaType     String   // "movie" or "tv"
  title         String
  posterPath    String?
  backdropPath  String?
  releaseDate   String?  // For movies
  firstAirDate  String?  // For TV shows
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, tmdbId, mediaType])
  @@map("watchlist_items")
  @@index([userId])
  @@index([createdAt])
}

enum PlaylistVisibility {
  PUBLIC
  FOLLOWERS_ONLY
  PRIVATE
}

// Playlists - user-created collections
model Playlist {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name          String
  description   String?
  isPublic      Boolean  @default(false) // Deprecated, use visibility instead
  visibility    PlaylistVisibility @default(PRIVATE)
  coverImage    String?  // URL to cover image
  likesCount    Int      @default(0) // Number of users who liked this playlist
  
  items         PlaylistItem[]
  sharedPlaylists SharedPlaylist[]
  engagementEvents PlaylistEngagementEvent[]
  likedBy       LikedPlaylist[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("playlists")
  @@index([userId])
  @@index([isPublic])
  @@index([visibility])
  @@index([likesCount])
}

// Items in a playlist
model PlaylistItem {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  playlistId    String   @db.ObjectId
  playlist      Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  
  // TMDB data
  tmdbId        Int
  mediaType     String   // "movie" or "tv"
  title         String
  posterPath    String?
  backdropPath String?
  releaseDate   String?
  firstAirDate  String?
  
  // Order in playlist
  order         Int      @default(0)
  
  createdAt     DateTime @default(now())

  @@map("playlist_items")
  @@index([playlistId])
  @@unique([playlistId, tmdbId, mediaType])
}

enum PlaylistEngagementType {
  SHARE
  VISIT
}

model PlaylistEngagementEvent {
  id           String                   @id @default(auto()) @map("_id") @db.ObjectId
  playlistId   String                   @db.ObjectId
  playlist     Playlist                 @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  ownerId      String                   @db.ObjectId
  owner        User                     @relation("UserPlaylistEngagementOwnership", fields: [ownerId], references: [id], onDelete: Cascade)
  actorId      String?                  @db.ObjectId
  actor        User?                    @relation("UserPlaylistEngagementActor", fields: [actorId], references: [id])
  type         PlaylistEngagementType
  source       String?
  visitorToken String?
  metadata     Json?
  createdAt    DateTime                 @default(now())

  @@map("playlist_engagement_events")
  @@index([playlistId])
  @@index([ownerId, type])
  @@index([visitorToken])
}

// Reviews - user reviews for movies/TV shows
model Review {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // TMDB data
  tmdbId        Int
  mediaType     String   // "movie" or "tv"
  
  rating        Int      // 1-10 rating
  title         String?  // Review title
  content       String   // Review text
  
  // Engagement
  likes         Int      @default(0)
  helpful       Int      @default(0)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, tmdbId, mediaType])
  @@map("reviews")
  @@index([userId])
  @@index([tmdbId, mediaType])
}

// Forum posts - discussion threads
model ForumPost {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title         String
  content       String
  
  // Optional TMDB link
  tmdbId        Int?
  mediaType     String?  // "movie" or "tv"
  
  // Categories/Tags
  tags          String[] @default([])
  
  // Engagement
  views         Int      @default(0)
  likes         Int      @default(0)
  
  replies       ForumReply[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("forum_posts")
  @@index([userId])
  @@index([tmdbId, mediaType])
  @@index([createdAt])
}

// Forum replies - comments on forum posts
model ForumReply {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  postId        String   @db.ObjectId
  post          ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  content       String
  
  // Optional reply to another reply
  parentReplyId String?  @db.ObjectId
  
  likes         Int      @default(0)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("forum_replies")
  @@index([postId])
  @@index([userId])
}

// Shared playlists - tracking who shared playlists with whom
model SharedPlaylist {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  playlistId    String   @db.ObjectId
  playlist      Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  
  sharedById    String   @db.ObjectId
  sharedBy      User     @relation(fields: [sharedById], references: [id], onDelete: Cascade)
  
  // Optional: shared with specific user (if null, public share)
  sharedWithId  String?  @db.ObjectId
  
  shareToken    String   @unique // For public sharing via link
  
  createdAt     DateTime @default(now())

  @@map("shared_playlists")
  @@index([playlistId])
  @@index([sharedById])
}

// Recently Viewed - tracks movies and TV shows user has viewed
model RecentlyViewed {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // TMDB data
  tmdbId        Int      // Movie or TV show ID from TMDB
  mediaType     String   // "movie" or "tv"
  title         String
  posterPath    String?
  backdropPath  String?
  releaseDate   String?  // For movies
  firstAirDate  String?  // For TV shows
  
  viewedAt      DateTime @default(now())
  
  @@map("recently_viewed")
  @@index([userId])
  @@index([userId, viewedAt])
  @@unique([userId, tmdbId, mediaType])
}

// Viewing Log - Film Diary: tracks when user watched movies/TV shows with dates and notes
// Allows multiple viewings of the same film
model ViewingLog {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // TMDB data
  tmdbId        Int      // Movie or TV show ID from TMDB
  mediaType     String   // "movie" or "tv"
  title         String
  posterPath    String?
  backdropPath  String?
  releaseDate   String?  // For movies
  firstAirDate  String?  // For TV shows
  
  // Diary entry
  watchedAt     DateTime // When the user watched it (can be in the past)
  notes         String?  // Optional notes about this viewing
  rating        Int?     // 1-5 star rating (optional)
  tags          String[] @default([]) // Tags for grouping (e.g., Netflix, horror)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  comments      ViewingLogComment[]
  
  @@map("viewing_logs")
  @@index([userId])
  @@index([userId, watchedAt])
  @@index([tmdbId, mediaType])
}

// Comments on viewing logs (reviews)
model ViewingLogComment {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  viewingLogId  String   @db.ObjectId
  viewingLog    ViewingLog @relation(fields: [viewingLogId], references: [id], onDelete: Cascade)
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  content       String
  
  // Nested replies
  parentCommentId String? @db.ObjectId
  parentComment   ViewingLogComment? @relation("CommentReplies", fields: [parentCommentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies         ViewingLogComment[] @relation("CommentReplies")
  
  likes         Int      @default(0)
  reactions     CommentReaction[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("viewing_log_comments")
  @@index([viewingLogId])
  @@index([userId])
  @@index([parentCommentId])
  @@index([createdAt])
}

// Comment reactions - likes and emoji reactions
model CommentReaction {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  commentId     String   @db.ObjectId
  comment       ViewingLogComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Reaction type: "like" or emoji string (e.g., "üëç", "‚ù§Ô∏è", "üòÇ")
  reactionType  String   // "like" or emoji unicode
  
  createdAt     DateTime @default(now())

  @@unique([commentId, userId, reactionType])
  @@map("comment_reactions")
  @@index([commentId])
  @@index([userId])
  @@index([reactionType])
  @@index([createdAt])
}

enum AiChatIntent {
  RECOMMENDATION
  INFORMATION
}

model AiChatEvent {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  userId        String        @db.ObjectId
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Chat session tracking
  sessionId     String        // Unique session identifier for grouping messages
  
  // User message
  userMessage   String        // The user's query/message
  intent        AiChatIntent  // RECOMMENDATION or INFORMATION
  
  // AI response metadata
  aiResponse    String?       // The AI's text response
  responseTime  Int?          // Response time in milliseconds
  
  // Results data
  resultsCount  Int           @default(0) // Number of movies/TV shows returned
  resultIds     Int[]         @default([]) // TMDB IDs of results
  resultTypes   String[]      @default([]) // "movie" or "tv" for each result
  
  // Query metadata
  extractedGenres    Int[]    @default([]) // Genres extracted from query
  extractedKeywords  String[] @default([]) // Keywords extracted from query
  extractedYear      Int?     // Year filter if extracted
  extractedType      String?  // "movie" or "tv" if specified
  
  // User interaction
  resultsClicked   Int       @default(0) // How many results user clicked
  resultsAddedToPlaylist Int @default(0) // How many results added to playlist
  
  // Error tracking
  errorMessage  String?
  
  createdAt     DateTime      @default(now())

  @@map("ai_chat_events")
  @@index([userId])
  @@index([userId, createdAt])
  @@index([sessionId])
  @@index([intent])
}

// Chat sessions for persisting conversation history
model AiChatSession {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  userId        String        @db.ObjectId
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  sessionId     String        @unique // Unique session identifier
  mode          String        // "recommendation" or "information"
  title         String?       // Auto-generated or user-provided title
  messages      Json          // Array of chat messages
  metadata      Json?         // Additional metadata (results, etc.)
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@map("ai_chat_sessions")
  @@index([userId])
  @@index([userId, updatedAt])
}

// Follow system - users following each other
model Follow {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  followerId    String   @db.ObjectId
  follower      User     @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  followingId   String   @db.ObjectId
  following     User     @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())

  @@unique([followerId, followingId])
  @@map("follows")
  @@index([followerId])
  @@index([followingId])
  @@index([createdAt])
}

// Liked playlists - playlists users have liked (auto-saved to their library)
model LikedPlaylist {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  playlistId    String   @db.ObjectId
  playlist      Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  
  // Read-only flag (always true for liked playlists from others)
  isReadOnly    Boolean  @default(true)
  
  createdAt     DateTime @default(now())

  @@unique([userId, playlistId])
  @@map("liked_playlists")
  @@index([userId])
  @@index([playlistId])
  @@index([createdAt])
}
