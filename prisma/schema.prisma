// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// User model - synced with Clerk
model User {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  clerkId       String   @unique
  email         String
  username      String?  @unique
  displayName   String?
  avatarUrl     String?
  bannerUrl     String?
  bannerGradientId String? // ID of selected gradient (e.g., "gradient-1")
  bio           String?
  
  // Activity visibility settings
  activityVisibility String @default("PUBLIC") // "PUBLIC", "FOLLOWERS_ONLY", "PRIVATE"
  showRatingsInActivity Boolean @default(true)
  showReviewsInActivity Boolean @default(true)
  showListsInActivity Boolean @default(true)
  showPlaylistsInActivity Boolean @default(true)
  showWatchedInActivity Boolean @default(true)
  showLikedInActivity Boolean @default(true)
  showFollowedInActivity Boolean @default(true)
  
  // Watchlist visibility
  watchlistIsPublic Boolean @default(true) // Whether user's watchlist is publicly viewable
  
  // Notification preferences
  emailNotifications Boolean @default(true)
  pushNotifications Boolean @default(true)
  notifyOnNewFollowers Boolean @default(true)
  notifyOnNewReviews Boolean @default(true)
  notifyOnListUpdates Boolean @default(true)
  notifyOnPlaylistUpdates Boolean @default(true)
  notifyOnActivityLikes Boolean @default(true)
  notifyOnMentions Boolean @default(true)
  
  // Forum notification preferences
  notifyOnForumReplies Boolean @default(true) // NEW_REPLY, REPLY_TO_REPLY
  notifyOnForumMentions Boolean @default(true) // POST_MENTION, REPLY_MENTION
  notifyOnForumSubscriptions Boolean @default(true) // POST_SUBSCRIPTION
  
  // View preferences
  youtubeCardStyle String @default("centered") // "centered" (default) or "horizontal"
  
  // Admin & Moderation
  role            String   @default("USER") // "USER", "MODERATOR", "ADMIN", "SUPER_ADMIN"
  isForumModerator Boolean @default(false)
  isForumAdmin     Boolean @default(false)
  isBanned         Boolean @default(false)
  bannedAt         DateTime?
  bannedUntil      DateTime? // Temporary ban
  banReason        String?
  banAppealReason  String?  // User's appeal reason
  banAppealAt      DateTime? // When user appealed
  banAppealStatus  String?  // "pending", "reviewed", "approved", "rejected"
  isSuspended     Boolean @default(false)
  suspendedAt     DateTime?
  suspendedUntil  DateTime? // Temporary suspension
  suspendReason   String?
  suspendAppealReason String?  // User's appeal reason
  suspendAppealAt   DateTime? // When user appealed
  suspendAppealStatus String?  // "pending", "reviewed", "approved", "rejected"
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  preferences   UserPreferences?
  favorites     Favorite[]
  contentReactions ContentReaction[]
  playlists     Playlist[]
  reviews       Review[]
  reviewReactions ReviewReaction[]
  reviewReports ReviewReport[]
  forumPosts    ForumPost[]
  forumReplies  ForumReply[]
  forumPostReactions ForumPostReaction[]
  forumReplyReactions ForumReplyReaction[]
  forumPostReports ForumPostReport[]
  forumReplyReports ForumReplyReport[]
  forumPostReportReviews ForumPostReport[] @relation("ForumPostReportReviews")
  forumReplyReportReviews ForumReplyReport[] @relation("ForumReplyReportReviews")
  forumCategories ForumCategory[]
  moderationActions ForumModerationAction[]
  forumNotifications ForumNotification[]
  forumPostSubscriptions ForumPostSubscription[]
  forumBookmarks ForumBookmark[]
  forumReplySubscriptions ForumReplySubscription[]
  forumReplyBookmarks ForumReplyBookmark[]
  forumPostRevisions ForumPostRevision[]
  forumBadges UserForumBadge[]
  forumNotificationActors ForumNotification[] @relation("ForumNotificationActors")
  sharedPlaylists SharedPlaylist[]
  recentlyViewed RecentlyViewed[]
  viewingLogs   ViewingLog[]
  episodeViewingLogs EpisodeViewingLog[]
  playlistEngagements PlaylistEngagementEvent[] @relation("UserPlaylistEngagementOwnership")
  playlistEngagementActions PlaylistEngagementEvent[] @relation("UserPlaylistEngagementActor")
  listEngagements ListEngagementEvent[] @relation("UserListEngagementOwnership")
  listEngagementActions ListEngagementEvent[] @relation("UserListEngagementActor")
  aiChatEvents AiChatEvent[]
  aiChatSessions AiChatSession[]
  pageViews     PageView[]
  
  // Social features
  followers     Follow[] @relation("UserFollowers")
  following     Follow[] @relation("UserFollowing")
  likedPlaylists LikedPlaylist[]
  viewingLogComments ViewingLogComment[]
  commentReactions CommentReaction[]
  watchlistItems WatchlistItem[]
  channelWatchlistItems ChannelWatchlistItem[]
  favoriteChannels FavoriteChannel[]
  youtubeVideoFavorites YouTubeVideoFavorite[]
  youtubeVideoWatchlistItems YouTubeVideoWatchlistItem[]
  youtubeNotifications YouTubeNotification[]
  youtubeVideoViews YouTubeVideoView[]
  channelReviews ChannelReview[]
  channelReviewVotes ChannelReviewVote[]
  youtubeChannelLists YouTubeChannelList[]
  youtubeChannelListFollows YouTubeChannelListFollow[]
  youtubeBadges UserYouTubeBadge[]
  feedback Feedback[]
  feedbackReplies Feedback[] @relation("FeedbackReplies")
  feedbackReplyHistory FeedbackReply[]
  feedbackNotes FeedbackNote[]
  feedbackTags FeedbackTag[]
  feedbackActivities FeedbackActivity[]
  assignedFeedback Feedback[] @relation("AssignedFeedback")
  generalNotifications GeneralNotification[]
  activities Activity[]
  followedActivities Activity[] @relation("UserFollowedActivities")
  activityLikes ActivityLike[]
  lists List[]
  likedLists LikedList[]
  listComments ListComment[]
  listCommentReactions ListCommentReaction[]
  trendAlerts TrendAlert[]
  userLinks   UserLink[]
  linkPage    LinkPage?
  linkPageDailyStats LinkPageDailyStat[]
  linkPagePeakNotifications LinkPagePeakNotification[]

  @@map("users")
}

// Link-in-bio page (one per user): theme, bio, and optional custom share preview (OG)
model LinkPage {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String   @unique @db.ObjectId
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bio          String?
  theme        Json?    // { buttonStyle?, backgroundColor?, fontFamily? }
  ogTitle      String?  // custom title when shared on socials
  ogDescription String? // custom description when shared
  ogImageUrl   String?  // custom image URL when shared (absolute)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("link_pages")
}

// Link-in-bio link item (socials, affiliate, in-app lists/playlists, custom with banner)
model UserLink {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  userId           String   @db.ObjectId
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  label            String
  url              String
  order            Int      @default(0)
  isActive         Boolean  @default(true)
  icon             String?  // optional icon name (e.g. "link", "instagram")
  resourceType     String?  // "list" | "playlist" | "profile" for in-app links
  resourceId       String?  // list/playlist id for resolving URL
  bannerImageUrl   String?  // custom banner (Cloudinary) ‚Äì link uses card design when set
  customDescription String? // short description when banner set; truncated to one line on display
  isSensitiveContent Boolean @default(false) // if true, show consent screen before opening link
  clicks           Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("user_links")
  @@index([userId])
  @@index([userId, order])
}

// Daily aggregates for link page analytics (views, clicks per day)
model LinkPageDailyStat {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date        DateTime // day (store as start of day UTC)
  pageViews   Int      @default(0)
  totalClicks Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, date])
  @@map("link_page_daily_stats")
  @@index([userId])
}

// When we sent a peak-activity notification (for showing "notification sent" on graph)
model LinkPagePeakNotification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sentAt    DateTime @default(now())
  date      DateTime // the day that had the peak
  metric    String   // e.g. "views", "clicks"
  value     Int      // value that triggered the notification
  createdAt DateTime @default(now())

  @@map("link_page_peak_notifications")
  @@index([userId])
  @@index([userId, date])
}

// User preferences from onboarding
model UserPreferences {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  userId            String   @unique @db.ObjectId
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Genre preferences (stored as array of genre IDs from TMDB)
  favoriteGenres    Int[]    @default([])
  dislikedGenres    Int[]    @default([])
  
  // Content preferences
  preferredTypes    String[] @default([]) // ["movie", "tv"]
  minRating         Float?    // Minimum rating user wants to see
  preferredLanguages String[] @default([]) // ISO 639-1 codes
  
  // Release year preferences
  minYear           Int?
  maxYear           Int?
  
  // Forum category preferences (array of category IDs user wants to see in sidebar)
  forumCategoryIds  String[] @default([]) // Array of ForumCategory IDs
  
  // Selected streaming providers/services (array of provider IDs)
  selectedProviders Int[] @default([]) // Array of watch provider IDs
  
  // Onboarding completed flag
  onboardingCompleted Boolean @default(false)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("user_preferences")
}

// Favorites - movies and TV shows user likes
model Favorite {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // TMDB data
  tmdbId        Int      // Movie or TV show ID from TMDB
  mediaType     String   // "movie" or "tv"
  title         String
  posterPath    String?
  backdropPath String?
  releaseDate   String?  // For movies
  firstAirDate  String?  // For TV shows
  
  createdAt     DateTime @default(now())

  @@unique([userId, tmdbId, mediaType])
  @@map("favorites")
  @@index([userId])
}

// Content Reactions - likes and dislikes for movies and TV shows
model ContentReaction {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // TMDB data
  tmdbId        Int      // Movie or TV show ID from TMDB
  mediaType     String   // "movie" or "tv"
  
  // Reaction type: "like" or "dislike"
  reactionType  String   // "like" or "dislike"
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, tmdbId, mediaType])
  @@map("content_reactions")
  @@index([userId])
  @@index([tmdbId, mediaType])
  @@index([tmdbId, mediaType, reactionType])
  @@index([createdAt])
}

// Watchlist - movies and TV shows user wants to watch
model WatchlistItem {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // TMDB data
  tmdbId        Int      // Movie or TV show ID from TMDB
  mediaType     String   // "movie" or "tv"
  title         String
  posterPath    String?
  backdropPath  String?
  releaseDate   String?  // For movies
  firstAirDate  String?  // For TV shows
  
  // Order/priority (1-based, 0 means not ordered)
  order         Int      @default(0)
  
  // User note
  note          String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, tmdbId, mediaType])
  @@map("watchlist_items")
  @@index([userId])
  @@index([createdAt])
  @@index([userId, order])
}

enum PlaylistVisibility {
  PUBLIC
  FOLLOWERS_ONLY
  PRIVATE
}

// Playlists - user-created collections
model Playlist {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name          String
  description   String?
  isPublic      Boolean  @default(false) // Deprecated, use visibility instead
  visibility    PlaylistVisibility @default(PRIVATE)
  coverImage    String?  // URL to cover image
  likesCount    Int      @default(0) // Number of users who liked this playlist
  
  items         PlaylistItem[]
  youtubeItems  YouTubePlaylistItem[]
  sharedPlaylists SharedPlaylist[]
  engagementEvents PlaylistEngagementEvent[]
  likedBy       LikedPlaylist[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("playlists")
  @@index([userId])
  @@index([isPublic])
  @@index([visibility])
  @@index([likesCount])
}

// Items in a playlist
model PlaylistItem {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  playlistId    String   @db.ObjectId
  playlist      Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  
  // TMDB data
  tmdbId        Int
  mediaType     String   // "movie" or "tv"
  title         String
  posterPath    String?
  backdropPath String?
  releaseDate   String?
  firstAirDate  String?
  
  // Order in playlist
  order         Int      @default(0)
  
  // User note
  note          String?
  
  createdAt     DateTime @default(now())

  @@map("playlist_items")
  @@index([playlistId])
  @@unique([playlistId, tmdbId, mediaType])
}

enum PlaylistEngagementType {
  SHARE
  VISIT
}

model PlaylistEngagementEvent {
  id           String                   @id @default(auto()) @map("_id") @db.ObjectId
  playlistId   String                   @db.ObjectId
  playlist     Playlist                 @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  ownerId      String                   @db.ObjectId
  owner        User                     @relation("UserPlaylistEngagementOwnership", fields: [ownerId], references: [id], onDelete: Cascade)
  actorId      String?                  @db.ObjectId
  actor        User?                    @relation("UserPlaylistEngagementActor", fields: [actorId], references: [id])
  type         PlaylistEngagementType
  source       String?
  visitorToken String?
  metadata     Json?
  createdAt    DateTime                 @default(now())

  @@map("playlist_engagement_events")
  @@index([playlistId])
  @@index([ownerId, type])
  @@index([visitorToken])
}

// Reviews - user reviews for movies/TV shows
model Review {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // TMDB data
  tmdbId        Int
  mediaType     String   // "movie" or "tv"
  
  rating        Int      // 1-10 rating
  title         String?  // Review title
  content       String   // Review text
  containsSpoilers Boolean @default(false) // Whether review contains spoilers
  
  // Engagement
  helpful       Int      @default(0)
  isFeatured    Boolean  @default(false) // Featured reviews shown first
  
  reactions     ReviewReaction[]
  reports       ReviewReport[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, tmdbId, mediaType])
  @@map("reviews")
  @@index([userId])
  @@index([tmdbId, mediaType])
  @@index([createdAt])
  @@index([isFeatured, createdAt])
  @@index([rating])
}

// Review reactions - likes and emoji reactions
model ReviewReaction {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  reviewId      String   @db.ObjectId
  review        Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Reaction type: "like", "helpful", or emoji string (e.g., "üëç", "‚ù§Ô∏è", "üòÇ")
  reactionType  String   // "like", "helpful", or emoji unicode
  
  createdAt     DateTime @default(now())

  @@unique([reviewId, userId, reactionType])
  @@map("review_reactions")
  @@index([reviewId])
  @@index([userId])
  @@index([reactionType])
}

// Review reports - user reports for inappropriate reviews
model ReviewReport {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  reviewId      String   @db.ObjectId
  review        Review   @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  reason        String   // Report reason (spam, harassment, etc.)
  description   String?  // Optional additional details
  
  createdAt     DateTime @default(now())

  @@unique([reviewId, userId])
  @@map("review_reports")
  @@index([reviewId])
  @@index([userId])
  @@index([createdAt])
}

// Forum categories - structured categories for organizing posts
model ForumCategory {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  name          String   @unique
  slug          String   @unique
  description   String?
  icon          String?  // Icon name or emoji
  color         String?  // Hex color for UI
  order         Int      @default(0) // Display order
  isActive      Boolean  @default(true)
  postCount     Int      @default(0) // Cached count of posts in this category
  
  createdById   String?  @db.ObjectId
  createdBy     User?    @relation(fields: [createdById], references: [id], onDelete: SetNull)
  posts         ForumPost[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("forum_categories")
  @@index([isActive])
  @@index([order])
}

// Forum posts - discussion threads
model ForumPost {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title         String
  slug          String  @unique
  content       String
  
  // Optional TMDB link
  tmdbId        Int?
  mediaType     String?  // "movie" or "tv"
  
  // Category
  categoryId    String?  @db.ObjectId
  category      ForumCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  
  // Tags (user-defined tags, separate from categories)
  tags          String[] @default([])
  
  // Category-specific metadata (JSON field for flexible data storage)
  // Examples:
  // - Bug reports: { severity, stepsToReproduce, expectedBehavior, actualBehavior, browserInfo, screenshots }
  // - Feature requests: { priority, useCase, currentWorkaround, mockups }
  // - Playlists/Lists/Watchlists: { linkId, linkType, whyRecommend, thumbnail }
  metadata      Json?   // Category-specific metadata stored as JSON
  
  // Engagement
  views         Int      @default(0)
  score         Int      @default(0) // upvotes - downvotes
  
  // Post scheduling
  scheduledAt   DateTime? // If set, post will be published at this time
  
  // Post status
  status        String   @default("PUBLIC") // "PUBLIC" or "PRIVATE" (draft)
  
  // Moderation
  isHidden      Boolean  @default(false)
  isLocked      Boolean  @default(false)
  hiddenAt      DateTime?
  lockedAt      DateTime?
  hiddenById    String?  @db.ObjectId
  lockedById    String?  @db.ObjectId
  
  replies       ForumReply[]
  reactions     ForumPostReaction[]
  reports       ForumPostReport[]
  notifications ForumNotification[]
  subscriptions ForumPostSubscription[]
  bookmarks ForumBookmark[]
  revisions ForumPostRevision[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("forum_posts")
  @@index([userId])
  @@index([categoryId])
  @@index([tmdbId, mediaType])
  @@index([createdAt])
  @@index([title]) // For search
  @@index([scheduledAt])
  @@index([status])
}

// Forum replies - comments on forum posts
model ForumReply {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  postId        String   @db.ObjectId
  post          ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  content       String
  
  // Optional reply to another reply
  parentReplyId String?  @db.ObjectId
  parentReply   ForumReply? @relation("ReplyReplies", fields: [parentReplyId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  childReplies  ForumReply[] @relation("ReplyReplies")
  
  score         Int      @default(0) // upvotes - downvotes
  
  // Moderation
  isHidden      Boolean  @default(false)
  hiddenAt      DateTime?
  hiddenById    String?  @db.ObjectId
  
  reactions     ForumReplyReaction[]
  reports       ForumReplyReport[]
  notifications ForumNotification[]
  subscriptions ForumReplySubscription[]
  bookmarks     ForumReplyBookmark[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("forum_replies")
  @@index([postId])
  @@index([userId])
  @@index([parentReplyId])
}

// Forum post reactions
model ForumPostReaction {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  postId        String   @db.ObjectId
  post          ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reactionType  String   // "upvote" or "downvote"
  createdAt     DateTime @default(now())

  @@unique([postId, userId])
  @@map("forum_post_reactions")
  @@index([postId])
  @@index([userId])
}

// Forum reply reactions
model ForumReplyReaction {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  replyId       String   @db.ObjectId
  reply         ForumReply @relation(fields: [replyId], references: [id], onDelete: Cascade)
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reactionType  String   // "upvote" or "downvote"
  createdAt     DateTime @default(now())

  @@unique([replyId, userId])
  @@map("forum_reply_reactions")
  @@index([replyId])
  @@index([userId])
}

// Forum post reports - user reports for inappropriate posts
model ForumPostReport {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  postId        String   @db.ObjectId
  post          ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  reason        String   // Report reason (spam, harassment, etc.)
  description   String?  // Optional additional details
  
  // Appeal system
  status        String   @default("pending") // "pending", "reviewed", "appealed", "appeal_approved", "appeal_rejected"
  appealReason  String?  // Owner's appeal reason
  appealAt      DateTime? // When owner appealed
  reviewedAt    DateTime? // When admin reviewed
  reviewedById  String?  @db.ObjectId // Admin who reviewed
  reviewedBy    User?    @relation("ForumPostReportReviews", fields: [reviewedById], references: [id], onDelete: SetNull)
  reviewNotes   String?  // Admin's review notes
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([postId, userId])
  @@map("forum_post_reports")
  @@index([postId])
  @@index([userId])
  @@index([createdAt])
  @@index([status])
}

// Forum reply reports - user reports for inappropriate replies
model ForumReplyReport {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  replyId       String   @db.ObjectId
  reply         ForumReply @relation(fields: [replyId], references: [id], onDelete: Cascade)
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  reason        String   // Report reason (spam, harassment, etc.)
  description   String?  // Optional additional details
  
  // Appeal system
  status        String   @default("pending") // "pending", "reviewed", "appealed", "appeal_approved", "appeal_rejected"
  appealReason  String?  // Owner's appeal reason
  appealAt      DateTime? // When owner appealed
  reviewedAt    DateTime? // When admin reviewed
  reviewedById  String?  @db.ObjectId // Admin who reviewed
  reviewedBy    User?    @relation("ForumReplyReportReviews", fields: [reviewedById], references: [id], onDelete: SetNull)
  reviewNotes   String?  // Admin's review notes
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([replyId, userId])
  @@map("forum_reply_reports")
  @@index([replyId])
  @@index([userId])
  @@index([createdAt])
  @@index([status])
}

// Forum moderation actions - audit log for moderation
model ForumModerationAction {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  moderatorId   String   @db.ObjectId
  moderator     User     @relation(fields: [moderatorId], references: [id], onDelete: Cascade)
  
  actionType    String   // "DELETE_POST", "HIDE_POST", "UNHIDE_POST", "LOCK_POST", "UNLOCK_POST", "DELETE_REPLY", "HIDE_REPLY", "WARN_USER", "BAN_USER", "UNBAN_USER"
  targetType    String   // "POST", "REPLY", "USER"
  targetId      String   // ID of the target (post, reply, or user)
  
  reason        String?
  notes         String?
  
  createdAt     DateTime @default(now())

  @@map("forum_moderation_actions")
  @@index([moderatorId])
  @@index([targetType, targetId])
  @@index([createdAt])
}

// Forum notifications - notifications for forum activity
model ForumNotification {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type          String   // "NEW_REPLY", "REPLY_TO_REPLY", "POST_SUBSCRIPTION"
  postId        String?  @db.ObjectId
  post          ForumPost? @relation(fields: [postId], references: [id], onDelete: Cascade)
  replyId       String?  @db.ObjectId
  reply         ForumReply? @relation(fields: [replyId], references: [id], onDelete: Cascade)
  
  // Actor (who performed the action)
  actorId       String?  @db.ObjectId
  actor         User?    @relation("ForumNotificationActors", fields: [actorId], references: [id], onDelete: SetNull)
  
  // Notification content
  title         String   // e.g., "New reply to your post"
  message       String?  // Optional additional message
  
  // Notification status
  isRead        Boolean  @default(false)
  readAt        DateTime?
  
  createdAt     DateTime @default(now())

  @@map("forum_notifications")
  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([postId])
  @@index([replyId])
  @@index([actorId])
}

// Forum post subscriptions - users following posts for notifications
model ForumPostSubscription {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  postId        String   @db.ObjectId
  post          ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())

  @@unique([userId, postId])
  @@map("forum_post_subscriptions")
  @@index([userId])
  @@index([postId])
  @@index([createdAt])
}

// Forum post bookmarks - users saving/bookmarking posts
model ForumBookmark {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  postId        String   @db.ObjectId
  post          ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())

  @@unique([userId, postId])
  @@map("forum_bookmarks")
  @@index([userId])
  @@index([postId])
  @@index([createdAt])
}

// Forum reply subscriptions - users following replies for notifications
model ForumReplySubscription {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  replyId       String   @db.ObjectId
  reply         ForumReply @relation(fields: [replyId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())

  @@unique([userId, replyId])
  @@map("forum_reply_subscriptions")
  @@index([userId])
  @@index([replyId])
  @@index([createdAt])
}

// Forum reply bookmarks - users saving/bookmarking replies
model ForumReplyBookmark {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  replyId       String   @db.ObjectId
  reply         ForumReply @relation(fields: [replyId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())

  @@unique([userId, replyId])
  @@map("forum_reply_bookmarks")
  @@index([userId])
  @@index([replyId])
  @@index([createdAt])
}

// Forum post revisions - edit history tracking
model ForumPostRevision {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  postId        String   @db.ObjectId
  post          ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  title         String
  content       String
  tags          String[] @default([])
  categoryId    String?  @db.ObjectId
  metadata      Json?
  
  editedBy      String   @db.ObjectId
  editor        User     @relation(fields: [editedBy], references: [id], onDelete: Cascade)
  
  editedAt      DateTime @default(now())

  @@map("forum_post_revisions")
  @@index([postId])
  @@index([editedBy])
  @@index([editedAt])
}

// Forum badges - achievement definitions
model ForumBadge {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  slug          String   @unique
  name          String
  description   String
  icon          String?
  criteria      Json     // { minPosts, minReplies, minUpvotes, minReputation, minFollowers }
  
  awardedTo     UserForumBadge[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("forum_badges")
}

// User forum badges - badges awarded to users
model UserForumBadge {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  badgeId       String   @db.ObjectId
  badge         ForumBadge @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  awardedAt     DateTime @default(now())

  @@map("user_forum_badges")
  @@unique([badgeId, userId])
  @@index([userId])
  @@index([badgeId])
  @@index([awardedAt])
}

// Shared playlists - tracking who shared playlists with whom
model SharedPlaylist {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  playlistId    String   @db.ObjectId
  playlist      Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  
  sharedById    String   @db.ObjectId
  sharedBy      User     @relation(fields: [sharedById], references: [id], onDelete: Cascade)
  
  // Optional: shared with specific user (if null, public share)
  sharedWithId  String?  @db.ObjectId
  
  shareToken    String   @unique // For public sharing via link
  
  createdAt     DateTime @default(now())

  @@map("shared_playlists")
  @@index([playlistId])
  @@index([sharedById])
}

// Recently Viewed - tracks movies and TV shows user has viewed
model RecentlyViewed {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // TMDB data
  tmdbId        Int      // Movie or TV show ID from TMDB
  mediaType     String   // "movie" or "tv"
  title         String
  posterPath    String?
  backdropPath  String?
  releaseDate   String?  // For movies
  firstAirDate  String?  // For TV shows
  
  viewedAt      DateTime @default(now())
  
  @@map("recently_viewed")
  @@index([userId])
  @@index([userId, viewedAt])
  @@unique([userId, tmdbId, mediaType])
}

// Viewing Log - Film Diary: tracks when user watched movies/TV shows with dates and notes
// Allows multiple viewings of the same film
model ViewingLog {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // TMDB data
  tmdbId        Int      // Movie or TV show ID from TMDB
  mediaType     String   // "movie" or "tv"
  title         String
  posterPath    String?
  backdropPath  String?
  releaseDate   String?  // For movies
  firstAirDate  String?  // For TV shows
  
  // Diary entry
  watchedAt     DateTime // When the user watched it (can be in the past)
  notes         String?  // Optional notes about this viewing
  rating        Int?     // 1-5 star rating (optional)
  tags          String[] @default([]) // Tags for grouping (e.g., Netflix, horror)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  comments      ViewingLogComment[]
  
  @@map("viewing_logs")
  @@index([userId])
  @@index([userId, watchedAt])
  @@index([tmdbId, mediaType])
}

// Episode Viewing Log - tracks individual TV episodes watched
model EpisodeViewingLog {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // TV Show data
  tvShowTmdbId  Int      // TV show ID from TMDB
  tvShowTitle   String   // TV show title (cached)
  
  // Episode data
  episodeId     Int      // Episode ID from TMDB
  seasonNumber  Int      // Season number
  episodeNumber Int      // Episode number within season
  
  // Viewing data
  watchedAt     DateTime @default(now()) // When the user watched it
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([userId, tvShowTmdbId, episodeId])
  @@map("episode_viewing_logs")
  @@index([userId])
  @@index([userId, tvShowTmdbId])
  @@index([tvShowTmdbId, seasonNumber, episodeNumber])
}

// Comments on viewing logs (reviews)
model ViewingLogComment {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  viewingLogId  String   @db.ObjectId
  viewingLog    ViewingLog @relation(fields: [viewingLogId], references: [id], onDelete: Cascade)
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  content       String
  
  // Nested replies
  parentCommentId String? @db.ObjectId
  parentComment   ViewingLogComment? @relation("CommentReplies", fields: [parentCommentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies         ViewingLogComment[] @relation("CommentReplies")
  
  likes         Int      @default(0)
  reactions     CommentReaction[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("viewing_log_comments")
  @@index([viewingLogId])
  @@index([userId])
  @@index([parentCommentId])
  @@index([createdAt])
}

// Comment reactions - likes and emoji reactions
model CommentReaction {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  commentId     String   @db.ObjectId
  comment       ViewingLogComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Reaction type: "like" or emoji string (e.g., "üëç", "‚ù§Ô∏è", "üòÇ")
  reactionType  String   // "like" or emoji unicode
  
  createdAt     DateTime @default(now())

  @@unique([commentId, userId, reactionType])
  @@map("comment_reactions")
  @@index([commentId])
  @@index([userId])
  @@index([reactionType])
  @@index([createdAt])
}

enum AiChatIntent {
  RECOMMENDATION
  INFORMATION
}

model AiChatEvent {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  userId        String        @db.ObjectId
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Chat session tracking
  sessionId     String        // Unique session identifier for grouping messages
  
  // User message
  userMessage   String        // The user's query/message
  intent        AiChatIntent  // RECOMMENDATION or INFORMATION
  
  // AI response metadata
  aiResponse    String?       // The AI's text response
  responseTime  Int?          // Response time in milliseconds
  model         String?       // Model used (e.g., "gpt-4o", "gpt-4o-mini")
  promptTokens  Int?          // Number of input tokens used
  completionTokens Int?       // Number of output tokens used
  totalTokens   Int?          // Total tokens used (prompt + completion)
  
  // Results data
  resultsCount  Int           @default(0) // Number of movies/TV shows returned
  resultIds     Int[]         @default([]) // TMDB IDs of results
  resultTypes   String[]      @default([]) // "movie" or "tv" for each result
  
  // Query metadata
  extractedGenres    Int[]    @default([]) // Genres extracted from query
  extractedKeywords  String[] @default([]) // Keywords extracted from query
  extractedYear      Int?     // Year filter if extracted
  extractedType      String?  // "movie" or "tv" if specified
  
  // User interaction
  resultsClicked   Int       @default(0) // How many results user clicked
  resultsAddedToPlaylist Int @default(0) // How many results added to playlist
  
  // Error tracking
  errorMessage  String?
  
  createdAt     DateTime      @default(now())

  @@map("ai_chat_events")
  @@index([userId])
  @@index([userId, createdAt])
  @@index([sessionId])
  @@index([intent])
}

// Chat sessions for persisting conversation history
model AiChatSession {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  userId        String        @db.ObjectId
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  sessionId     String        @unique // Unique session identifier
  mode          String        // "recommendation" or "information"
  title         String?       // Auto-generated or user-provided title
  messages      Json          // Array of chat messages
  metadata      Json?         // Additional metadata (results, etc.)
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@map("ai_chat_sessions")
  @@index([userId])
  @@index([userId, updatedAt])
}

// Follow system - users following each other
model Follow {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  followerId    String   @db.ObjectId
  follower      User     @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  followingId   String   @db.ObjectId
  following     User     @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())

  @@unique([followerId, followingId])
  @@map("follows")
  @@index([followerId])
  @@index([followingId])
  @@index([createdAt])
}

// Liked playlists - playlists users have liked (auto-saved to their library)
model LikedPlaylist {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  playlistId    String   @db.ObjectId
  playlist      Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  
  // Read-only flag (always true for liked playlists from others)
  isReadOnly    Boolean  @default(true)
  
  createdAt     DateTime @default(now())

  @@unique([userId, playlistId])
  @@map("liked_playlists")
  @@index([userId])
  @@index([playlistId])
  @@index([createdAt])
}

// Activity Feed - tracks user actions for social feed
enum ActivityType {
  LOGGED_FILM      // User logged a film to diary
  RATED_FILM       // User rated a film
  REVIEWED_FILM    // User wrote a review/notes
  LIKED_FILM       // User liked a film
  CREATED_LIST     // User created a list
  CREATED_PLAYLIST // User created a playlist
  FOLLOWED_USER    // User followed someone
  CREATED_FORUM_POST   // User created a forum post
  CREATED_FORUM_REPLY  // User replied to a forum post
}

model Activity {
  id            String       @id @default(auto()) @map("_id") @db.ObjectId
  userId        String       @db.ObjectId
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type          ActivityType
  
  // Optional: related content (film, list, playlist, user)
  tmdbId        Int?         // For film-related activities
  mediaType     String?      // "movie" or "tv"
  title         String?      // Film title
  posterPath    String?      // Film poster
  
  // For list/playlist activities
  listId        String?      @db.ObjectId
  listName      String?      // List/playlist name
  
  // For follow activities
  followedUserId String?     @db.ObjectId
  followedUser   User?       @relation("UserFollowedActivities", fields: [followedUserId], references: [id], onDelete: Cascade)
  
  // Additional metadata
  rating        Int?         // For rating activities
  metadata      Json?        // Additional flexible data
  
  // Privacy settings
  visibility    String?      // "PUBLIC", "FOLLOWERS_ONLY", "PRIVATE" - inherits from user settings if null
  
  createdAt     DateTime     @default(now())
  
  likes         ActivityLike[]
  
  @@map("activities")
  @@index([userId, createdAt])
  @@index([userId, type])
  @@index([createdAt])
  @@index([tmdbId, mediaType])
}

// Activity likes - users can like activities in the feed
model ActivityLike {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  activityId String   @db.ObjectId
  activity   Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  userId     String   @db.ObjectId
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  
  @@unique([activityId, userId])
  @@map("activity_likes")
  @@index([activityId])
  @@index([userId])
}

// Lists - user-created ranked lists (different from playlists)
enum ListVisibility {
  PUBLIC
  FOLLOWERS_ONLY
  PRIVATE
}

model List {
  id            String       @id @default(auto()) @map("_id") @db.ObjectId
  userId        String       @db.ObjectId
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name          String
  description   String?
  visibility    ListVisibility @default(PRIVATE)
  tags          String[]     @default([])
  coverImage    String?      // URL to cover image
  
  // Moderation - users blocked from commenting
  blockedUsers  String[]     @default([]) // Array of user IDs
  
  items         ListItem[]
  likedBy       LikedList[]
  comments      ListComment[]
  engagementEvents ListEngagementEvent[]
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  
  @@map("lists")
  @@index([userId])
  @@index([visibility])
  @@index([createdAt])
}

// Items in a list (with ranking/position)
model ListItem {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  listId        String   @db.ObjectId
  list          List     @relation(fields: [listId], references: [id], onDelete: Cascade)
  
  // TMDB data
  tmdbId        Int
  mediaType     String   // "movie" or "tv"
  title         String
  posterPath    String?
  backdropPath  String?
  releaseDate   String?
  firstAirDate  String?
  
  // Ranking/position in the list (1-based)
  position      Int      @default(0)
  
  // User note
  note          String?
  
  createdAt     DateTime @default(now())
  
  @@map("list_items")
  @@index([listId])
  @@index([listId, position])
  @@unique([listId, tmdbId, mediaType])
}

// Liked Lists - lists that users have liked (PUBLIC or FOLLOWERS_ONLY only)
model LikedList {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  listId        String   @db.ObjectId
  list          List     @relation(fields: [listId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())

  @@unique([userId, listId])
  @@map("liked_lists")
  @@index([userId])
  @@index([listId])
  @@index([createdAt])
}

// List Comments - comments on lists
model ListComment {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  listId        String   @db.ObjectId
  list          List     @relation(fields: [listId], references: [id], onDelete: Cascade)
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  content       String
  
  // Nested replies
  parentCommentId String? @db.ObjectId
  parentComment   ListComment? @relation("ListCommentReplies", fields: [parentCommentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  replies         ListComment[] @relation("ListCommentReplies")
  
  // Reactions
  reactions     ListCommentReaction[]
  
  likes         Int      @default(0)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("list_comments")
  @@index([listId])
  @@index([userId])
  @@index([parentCommentId])
  @@index([createdAt])
}

// List Comment reactions - likes and emoji reactions
model ListCommentReaction {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  commentId     String   @db.ObjectId
  comment       ListComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Reaction type: "like" or emoji string (e.g., "üëç", "‚ù§Ô∏è", "üòÇ")
  reactionType  String   // "like" or emoji unicode
  
  createdAt     DateTime @default(now())

  @@unique([commentId, userId, reactionType])
  @@map("list_comment_reactions")
  @@index([commentId])
  @@index([userId])
  @@index([reactionType])
  @@index([createdAt])
}

enum ListEngagementType {
  SHARE
  VISIT
}

model ListEngagementEvent {
  id           String                 @id @default(auto()) @map("_id") @db.ObjectId
  listId       String                 @db.ObjectId
  list         List                   @relation(fields: [listId], references: [id], onDelete: Cascade)
  ownerId      String                 @db.ObjectId
  owner        User                   @relation("UserListEngagementOwnership", fields: [ownerId], references: [id], onDelete: Cascade)
  actorId      String?                @db.ObjectId
  actor        User?                  @relation("UserListEngagementActor", fields: [actorId], references: [id])
  type         ListEngagementType
  source       String?
  visitorToken String?
  metadata     Json?
  createdAt    DateTime               @default(now())

  @@map("list_engagement_events")
  @@index([listId])
  @@index([ownerId, type])
  @@index([visitorToken])
}

// YouTube Channels - Nollywood YouTube channel IDs
model YouTubeChannel {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  channelId     String   @unique // YouTube channel ID (starts with UC)
  slug          String?  @unique // Friendly slug/handle (e.g. @channelname)
  title         String?  // Channel title (optional, can be fetched from API)
  thumbnail     String?  // Channel thumbnail URL (optional)
  channelUrl    String?  // Full YouTube channel URL (optional)
  isActive      Boolean  @default(true) // Whether channel is active/visible
  isPrivate     Boolean  @default(false) // Whether channel is private (only visible to user who added it)
  isNollywood   Boolean  @default(false) // Whether channel is part of Nollywood collection
  addedByUserId String?  @db.ObjectId // User who added this channel (null for public channels)
  order         Int      @default(0) // Display order
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("youtube_channels")
  @@index([isActive])
  @@index([isPrivate])
  @@index([isNollywood])
  @@index([addedByUserId])
  @@index([order])
}

model ChannelReview {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  channelId     String
  rating        Int
  title         String?
  content       String
  tags          String[] @default([])
  summaryTags   String[] @default([])
  helpfulCount  Int      @default(0)
  notHelpfulCount Int    @default(0)
  isEdited      Boolean  @default(false)
  status        String   @default("published")

  votes         ChannelReviewVote[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, channelId])
  @@map("channel_reviews")
  @@index([channelId])
  @@index([rating])
  @@index([createdAt])
}

model ChannelReviewVote {
  id        String        @id @default(auto()) @map("_id") @db.ObjectId
  reviewId  String        @db.ObjectId
  review    ChannelReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  userId    String        @db.ObjectId
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  voteType  String        @default("UP") // "UP" or "DOWN"
  createdAt DateTime      @default(now())

  @@unique([reviewId, userId])
  @@map("channel_review_votes")
  @@index([reviewId])
  @@index([userId])
}

// Favorite Channels - User's favorite YouTube channels
// This model serves dual purpose:
// 1. Channels in user's feed (user pool) - all records
// 2. Favorite channels - records where isFavorite = true
model FavoriteChannel {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // YouTube channel data
  channelId     String   // YouTube channel ID (starts with UC)
  slug          String?
  title         String?  // Channel title (cached from API)
  thumbnail     String?  // Channel thumbnail URL (cached)
  channelUrl    String?  // Full YouTube channel URL (cached)
  
  // Favorite flag - distinguishes favorited channels from channels just in feed
  isFavorite    Boolean  @default(false)
  
  createdAt     DateTime @default(now())

  @@unique([userId, channelId])
  @@map("favorite_channels")
  @@index([userId])
  @@index([isFavorite])
  @@index([createdAt])
}

// Channel Watchlist - YouTube channels user wants to watch later
model ChannelWatchlistItem {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // YouTube channel data
  channelId     String   // YouTube channel ID (starts with UC)
  slug          String?
  title         String?  // Channel title (cached from API)
  thumbnail     String?  // Channel thumbnail URL (cached)
  channelUrl    String?  // Full YouTube channel URL (cached)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, channelId])
  @@map("channel_watchlist_items")
  @@index([userId])
  @@index([createdAt])
}

model YouTubeVideoFavorite {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  videoId       String
  title         String
  thumbnail     String?
  channelId     String
  channelTitle  String?
  duration      String?
  videoUrl      String
  description   String?
  publishedAt   String?
  createdAt     DateTime @default(now())

  @@unique([userId, videoId])
  @@map("youtube_video_favorites")
  @@index([userId])
  @@index([createdAt])
}

model YouTubeVideoWatchlistItem {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  videoId       String
  title         String
  thumbnail     String?
  channelId     String
  channelTitle  String?
  duration      String?
  videoUrl      String
  description   String?
  publishedAt   String?
  createdAt     DateTime @default(now())

  @@unique([userId, videoId])
  @@map("youtube_video_watchlist")
  @@index([userId])
  @@index([createdAt])
}

// YouTube Playlist Items - YouTube videos in user playlists
model YouTubePlaylistItem {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  playlistId    String   @db.ObjectId
  playlist      Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  
  // YouTube video data
  videoId       String   // YouTube video ID
  title         String
  thumbnail     String?  // Video thumbnail URL
  description   String?  // Video description
  duration      String?  // Video duration (ISO 8601 format)
  publishedAt   String?  // Video publish date
  channelId     String   // Channel ID that owns the video
  channelTitle  String?  // Channel title (cached)
  
  // Order in playlist
  order         Int      @default(0)
  
  createdAt     DateTime @default(now())

  @@map("youtube_playlist_items")
  @@index([playlistId])
  @@unique([playlistId, videoId])
}

// YouTube Notifications - New videos from favorite channels
model YouTubeNotification {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Channel that posted the video
  channelId     String
  channelTitle  String?
  channelThumbnail String?
  
  // Video details
  videoId       String
  videoTitle    String
  videoThumbnail String?
  videoUrl      String
  publishedAt   DateTime
  
  // Notification status
  isRead        Boolean  @default(false)
  readAt        DateTime?
  
  createdAt     DateTime @default(now())

  @@map("youtube_notifications")
  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([channelId])
  @@unique([userId, videoId])
}

// YouTube Video Analytics - View tracking and engagement
model YouTubeVideoView {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String?  @db.ObjectId
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  videoId       String
  channelId     String
  categoryId    String?  // YouTube video category ID (e.g., "1" for Film & Animation, "2" for Autos & Vehicles)
  
  // View tracking
  viewDuration  Int?     // Duration watched in seconds
  completed     Boolean  @default(false) // Whether video was watched to completion
  source        String?  // Where the video was viewed from (dashboard, channel, search, etc.)
  
  // Engagement
  liked         Boolean  @default(false)
  addedToWatchlist Boolean @default(false)
  addedToPlaylist Boolean @default(false)
  
  createdAt     DateTime @default(now())

  @@map("youtube_video_views")
  @@index([userId])
  @@index([videoId])
  @@index([channelId])
  @@index([categoryId])
  @@index([createdAt])
  @@index([userId, createdAt])
}

model YouTubeChannelList {
  id             String                    @id @default(auto()) @map("_id") @db.ObjectId
  userId         String                    @db.ObjectId
  user           User                      @relation(fields: [userId], references: [id], onDelete: Cascade)

  name           String
  description    String?
  coverImage     String?
  isPublic       Boolean                   @default(false)
  tags           String[]                  @default([])
  followersCount Int                       @default(0)

  items          YouTubeChannelListItem[]
  followedBy     YouTubeChannelListFollow[]

  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt

  @@map("youtube_channel_lists")
  @@index([userId])
  @@index([isPublic])
  @@index([followersCount])
}

model YouTubeChannelListItem {
  id                String              @id @default(auto()) @map("_id") @db.ObjectId
  listId            String              @db.ObjectId
  list              YouTubeChannelList  @relation(fields: [listId], references: [id], onDelete: Cascade)

  channelId         String
  channelTitle      String?
  channelThumbnail  String?
  channelDescription String?
  subscriberCount   String?
  videoCount        String?
  channelUrl        String?
  notes             String?
  position          Int                 @default(0)

  createdAt         DateTime            @default(now())

  @@map("youtube_channel_list_items")
  @@index([listId])
  @@unique([listId, channelId])
}

model YouTubeChannelListFollow {
  id        String              @id @default(auto()) @map("_id") @db.ObjectId
  listId    String              @db.ObjectId
  list      YouTubeChannelList  @relation(fields: [listId], references: [id], onDelete: Cascade)
  userId    String              @db.ObjectId
  user      User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime            @default(now())

  @@map("youtube_channel_list_follows")
  @@unique([listId, userId])
  @@index([listId])
  @@index([userId])
}

model YouTubeBadge {
  id               String               @id @default(auto()) @map("_id") @db.ObjectId
  slug             String               @unique
  name             String
  description      String?
  icon             String?
  minReviews       Int                  @default(0)
  minHelpfulVotes  Int                  @default(0)
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  awardedTo        UserYouTubeBadge[]

  @@map("youtube_badges")
}

model UserYouTubeBadge {
  id                     String       @id @default(auto()) @map("_id") @db.ObjectId
  badgeId                String       @db.ObjectId
  badge                  YouTubeBadge @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  userId                 String       @db.ObjectId
  user                   User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  awardedAt              DateTime     @default(now())
  reason                 String?
  reviewCountSnapshot    Int          @default(0)
  helpfulCountSnapshot   Int          @default(0)

  @@map("user_youtube_badges")
  @@unique([badgeId, userId])
  @@index([userId])
  @@index([badgeId])
}

// Video Snapshots - Track video metrics over time for trend analysis
model YouTubeVideoSnapshot {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  videoId       String
  channelId     String
  
  // Snapshot data from YouTube API
  viewCount     String   // Using String for BigInt compatibility
  likeCount     Int
  commentCount  Int
  title         String
  description   String?
  tags          String[] @default([])
  thumbnailUrl  String?
  publishedAt   DateTime
  
  // Calculated metrics
  viewVelocity  Float?   // Views per hour since publish
  engagementRate Float?  // (likes + comments) / views * 100
  
  snapshotDate  DateTime @default(now())
  
  @@map("youtube_video_snapshots")
  @@index([videoId, snapshotDate])
  @@index([channelId])
  @@index([snapshotDate])
  @@index([viewVelocity])
  @@index([engagementRate])
}

// Trends - Track trending keywords and topics
model YouTubeTrend {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  keyword       String
  category      String?
  
  // Trend metrics
  searchVolume  Int      // Estimated from API
  videoCount    Int      // Videos with this keyword
  avgViews      String   // Using String for BigInt
  avgEngagement Float
  momentum      Float    // Rate of change (positive = rising, negative = falling)
  
  period        String   // "daily", "weekly", "monthly"
  startDate     DateTime
  endDate       DateTime
  
  @@map("youtube_trends")
  @@index([keyword, period])
  @@index([momentum])
  @@index([startDate])
  @@index([category])
}

// Video Analysis - Title and thumbnail analysis data
model YouTubeVideoAnalysis {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  videoId       String   @unique
  
  // Title analysis
  titleLength   Int
  hasQuestion   Boolean  @default(false)
  hasBrackets   Boolean  @default(false)
  hasNumber     Boolean  @default(false)
  wordCount     Int
  topWords      String[] @default([])
  
  // Thumbnail analysis (basic - can be enhanced with image processing)
  hasFace       Boolean  @default(false)
  hasText       Boolean  @default(false)
  dominantColors String[] @default([])
  brightness    Float?
  
  // Performance metrics
  estimatedCTR  Float?
  viewCount     String   // Using String for BigInt
  engagementRate Float
  
  analyzedAt    DateTime @default(now())
  
  @@map("youtube_video_analyses")
  @@index([analyzedAt])
}

// Content Gap - High-demand, low-supply content opportunities
model ContentGap {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  keyword       String
  
  // Demand metrics
  searchVolume  Int      // Estimated search volume
  trendScore    Float    // Trend momentum score
  
  // Supply metrics
  videoCount    Int      // Number of existing videos
  avgVideoAge   Int      // Average days since publish
  topVideoViews String   // Views of top video (using String for BigInt)
  
  // Gap score (higher = bigger opportunity)
  gapScore      Float
  
  category      String?
  discoveredAt  DateTime @default(now())
  
  @@map("content_gaps")
  @@index([gapScore])
  @@index([category])
  @@index([discoveredAt])
  @@index([keyword])
}

// Channel Diagnostic - Analysis of competitor channels
model ChannelDiagnostic {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  channelId     String
  analyzedBy    String   @db.ObjectId  // User who requested
  
  // Performance metrics
  avgViews      String   // Using String for BigInt
  avgEngagement Float
  uploadFrequency Float  // Videos per week
  bestFormat    String?  // Most successful format
  
  // Growth metrics
  subscriberGrowthRate Float
  viewGrowthRate       Float
  
  // Pattern analysis
  avgTitleLength       Float?
  percentWithBrackets  Float?
  percentWithNumbers  Float?
  percentWithQuestions Float?
  percentWithFaces      Float?  // Thumbnails with faces
  percentWithText      Float?   // Thumbnails with text
  
  // Top performing videos (stored as video IDs)
  topVideosByViews     String[] @default([])
  topVideosByEngagement String[] @default([])
  
  analyzedAt    DateTime @default(now())
  
  @@unique([channelId, analyzedBy])
  @@map("channel_diagnostics")
  @@index([channelId])
  @@index([analyzedBy])
  @@index([analyzedAt])
}

// Video Format Classification
model VideoFormat {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  videoId       String   @unique
  
  format        String   // "tutorial", "list", "review", "vlog", "rant", "documentary", "reaction", "challenge"
  confidence    Float    // Classification confidence score (0-1)
  
  // Additional metadata
  category      String?  // Video category/topic
  detectedAt    DateTime @default(now())
  
  @@map("video_formats")
  @@index([format])
  @@index([category])
  @@index([detectedAt])
}

// Format Performance Tracking
model FormatPerformance {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  format        String
  category      String?
  
  avgViews      String   // Using String for BigInt
  avgEngagement Float
  videoCount    Int
  
  period        String   // "weekly", "monthly"
  calculatedAt  DateTime @default(now())
  
  @@map("format_performances")
  @@index([format, category])
  @@index([period])
  @@index([calculatedAt])
}

// Trend Alerts - User-defined alerts for trending opportunities
model TrendAlert {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  keyword       String
  category      String?
  
  // Alert conditions
  minMomentum   Float    // Minimum momentum threshold
  minSearchVolume Int    // Minimum search volume threshold
  
  // Status
  isActive      Boolean  @default(true)
  lastTriggered DateTime?
  triggerCount  Int      @default(0) // How many times this alert has been triggered
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("trend_alerts")
  @@index([userId])
  @@index([isActive])
  @@index([keyword])
  @@index([createdAt])
}

// Comment Question Mining - Extract questions from video comments
model CommentQuestion {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  videoId       String
  channelId     String
  
  question      String
  questionType  String?  // "how", "what", "why", "when", "where", "who"
  
  upvotes       Int      @default(0) // Comment likes
  replies       Int      @default(0)
  
  extractedAt   DateTime @default(now())
  
  @@map("comment_questions")
  @@index([videoId])
  @@index([channelId])
  @@index([questionType])
  @@index([extractedAt])
}

// Question Trends - Aggregated question patterns
model QuestionTrend {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  question          String
  normalizedQuestion String  // Normalized version for grouping
  
  frequency         Int      // How many times asked
  videos            String[] @default([]) // Video IDs where asked
  avgUpvotes        Float    @default(0)
  
  category          String?
  trendScore        Float    @default(0) // Based on frequency and engagement
  
  firstSeen         DateTime @default(now())
  lastSeen          DateTime @default(now())
  
  @@map("question_trends")
  @@index([normalizedQuestion])
  @@index([frequency])
  @@index([trendScore])
  @@index([category])
  @@index([lastSeen])
}

// Feedback - User feedback submissions
model Feedback {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId         String   @db.ObjectId
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  reason         String   // Feedback reason (Bug Report, Feature Request, etc.)
  priority       String   // Priority level (Low, Medium, High, Urgent)
  message        String   // Feedback message/content
  
  // User info at time of submission (for email replies)
  userEmail      String   // User's email at submission time
  username       String?  // Username at submission time
  
  // Admin response (deprecated - use FeedbackReply model instead)
  adminReply     String?  // Admin's reply message (legacy field)
  repliedAt      DateTime? // When admin replied (legacy field)
  repliedById    String?  @db.ObjectId // Admin who replied (legacy field)
  repliedBy      User?    @relation("FeedbackReplies", fields: [repliedById], references: [id], onDelete: SetNull)
  
  // Reply history
  replies        FeedbackReply[]
  
  // Advanced features
  assignedToId  String?  @db.ObjectId // Assigned admin/moderator
  assignedTo    User?    @relation("AssignedFeedback", fields: [assignedToId], references: [id], onDelete: SetNull)
  notes         FeedbackNote[]
  tags          FeedbackTag[]
  activities    FeedbackActivity[]
  
  status         String   @default("OPEN") // "OPEN", "IN_PROGRESS", "RESOLVED", "CLOSED"
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("feedback")
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([repliedById])
  @@index([assignedToId])
}

// Feedback Reply - Multiple replies per feedback
model FeedbackReply {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  feedbackId    String   @db.ObjectId
  feedback      Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  
  message       String   // Reply message
  status        String?  // Status at time of reply (optional - can be set separately)
  
  repliedById   String   @db.ObjectId
  repliedBy     User     @relation(fields: [repliedById], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())

  @@map("feedback_replies")
  @@index([feedbackId])
  @@index([repliedById])
  @@index([createdAt])
}

// General Notifications - for system-wide notifications (feedback, admin alerts, etc.)
model GeneralNotification {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type          String   // "FEEDBACK_SUBMITTED", "ADMIN_ALERT", etc.
  title         String   // Notification title
  message       String?  // Optional message
  
  // Link/action data
  linkUrl       String?  // URL to navigate to when clicked
  metadata      Json?   // Additional data (e.g., feedbackId, etc.)
  
  // Notification status
  isRead        Boolean  @default(false)
  readAt        DateTime?
  
  createdAt     DateTime @default(now())

  @@map("general_notifications")
  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([type])
}

// Feedback Note - Internal notes/comments for admins
model FeedbackNote {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  feedbackId    String   @db.ObjectId
  feedback      Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  
  note          String   // Note content
  isPrivate     Boolean  @default(true) // Private notes only visible to admins
  
  createdById   String   @db.ObjectId
  createdBy     User     @relation(fields: [createdById], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("feedback_notes")
  @@index([feedbackId])
  @@index([createdById])
  @@index([createdAt])
}

// Feedback Tag - Tags/labels for categorization
model FeedbackTag {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  feedbackId    String   @db.ObjectId
  feedback      Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  
  name          String   // Tag name (e.g., "bug", "feature", "urgent", "follow-up")
  color         String?  // Optional color for UI display
  
  createdById   String   @db.ObjectId
  createdBy     User     @relation(fields: [createdById], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())

  @@map("feedback_tags")
  @@index([feedbackId])
  @@index([name])
  @@index([createdById])
}

// Feedback Activity - Activity log/history
model FeedbackActivity {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  feedbackId    String   @db.ObjectId
  feedback      Feedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)
  
  action        String   // Action type: "STATUS_CHANGED", "ASSIGNED", "TAG_ADDED", "NOTE_ADDED", "PRIORITY_CHANGED", etc.
  description   String   // Human-readable description
  metadata      Json?    // Additional data (e.g., oldStatus, newStatus, oldPriority, newPriority)
  
  performedById String   @db.ObjectId
  performedBy   User     @relation(fields: [performedById], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())

  @@map("feedback_activities")
  @@index([feedbackId])
  @@index([performedById])
  @@index([createdAt])
  @@index([action])
}

// Website Traffic Analytics - Page views and visitor tracking
model PageView {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String?  @db.ObjectId
  user          User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Page information
  path          String   // Page path (e.g., "/dashboard", "/playlists/123")
  route         String?  // Route pattern (e.g., "/playlists/[id]")
  title         String?  // Page title
  
  // Visitor tracking
  visitorToken  String   // Unique visitor identifier (from cookie)
  sessionId     String?  // Session identifier
  
  // Traffic source
  referrer      String?  // HTTP referrer
  referrerDomain String? // Extracted referrer domain
  utmSource     String?  // UTM source parameter
  utmMedium     String?  // UTM medium parameter
  utmCampaign   String?  // UTM campaign parameter
  utmTerm       String?  // UTM term parameter
  utmContent    String?  // UTM content parameter
  
  // Geolocation
  country       String?  // Country code (e.g., "US", "GB")
  countryName   String?  // Country name
  region        String?  // Region/state
  city          String?  // City name
  ipAddress     String?  // IP address (hashed for privacy)
  
  // Device and browser
  userAgent     String?  // User agent string
  deviceType    String?  // "desktop", "mobile", "tablet"
  browser       String?  // Browser name
  os            String?  // Operating system
  
  // Metadata
  metadata      Json?    // Additional metadata
  
  createdAt     DateTime @default(now())

  @@map("page_views")
  @@index([userId])
  @@index([path])
  @@index([country])
  @@index([referrerDomain])
  @@index([utmSource])
  @@index([utmCampaign])
  @@index([visitorToken])
  @@index([createdAt])
  @@index([createdAt, country])
  @@index([createdAt, referrerDomain])
}

// YouTube tools visibility - admin-controlled (single config doc)
model YoutubeToolsVisibility {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  mode          String   @default("AVAILABLE_TO_ALL") // "HIDDEN_FROM_ALL" | "AVAILABLE_TO_ALL" | "INVITE_ONLY"
  allowedEmails String[] @default([]) // When INVITE_ONLY, list of emails (lowercase) that can see tools
  updatedAt     DateTime @updatedAt

  @@map("youtube_tools_visibility")
}
